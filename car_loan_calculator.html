<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½¦è´·è®¡ç®—å™¨</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è®¾ç½® Tailwind é…ç½®ï¼Œä½¿ç”¨ Inter å­—ä½“ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#1D4ED8', // Blue-700
                        'secondary': '#6B7280', // Gray-500
                        'accent': '#F59E0B', // Amber-500
                        'background': '#F9FAFB', // Gray-50
                    }
                }
            }
        }
    </script>
    <style>
        /* å¼ºåˆ¶æ‰€æœ‰è¾“å…¥æ¡†å’ŒæŒ‰é’®ä½¿ç”¨ Inter å­—ä½“ï¼Œå¹¶ç¡®ä¿ä¸­æ–‡å‹å¥½ */
        body {
            font-family: 'Inter', 'Noto Sans SC', 'sans-serif';
            background-color: theme('colors.background');
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 md:p-10 border border-gray-100">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">ğŸš™ è½¦è´·æœˆä¾›è®¡ç®—å™¨ (å¤šæ–¹å¼)</h1>
        <p class="text-secondary mb-8 text-center">è¾“å…¥æ‚¨çš„è´·æ¬¾ä¿¡æ¯ï¼Œå¹¶é€‰æ‹©è¿˜æ¬¾æ–¹å¼ï¼Œä»¥è®¡ç®—æ¯æœˆè¿˜æ¬¾é¢å’Œæ€»åˆ©æ¯ã€‚</p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- è¾“å…¥è¡¨å•åŒºåŸŸ -->
            <div class="space-y-6">
                
                <!-- è½¦è¾†æ€»ä»· -->
                <div class="relative">
                    <label for="price" class="block text-sm font-medium text-gray-700 mb-1">è½¦è¾†æ€»ä»· (RMB)</label>
                    <input type="number" id="price" value="200000" min="1000" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150" oninput="calculateLoan()">
                    <span class="absolute right-3 top-9 text-gray-400 text-sm">RMB</span>
                </div>

                <!-- é¦–ä»˜æ¯”ä¾‹ -->
                <div class="space-y-2">
                    <label for="downPaymentPercent" class="block text-sm font-medium text-gray-700 mb-1">é¦–ä»˜æ¯”ä¾‹ (%)</label>
                    <div class="relative">
                        <input type="number" id="downPaymentPercent" value="30" min="0" max="100" step="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150" oninput="calculateLoan()">
                        <span class="absolute right-3 top-3 text-gray-400 text-sm">%</span>
                    </div>
                    <div class="text-sm text-secondary bg-gray-100 p-2 rounded-lg flex justify-between">
                        <span>å®é™…é¦–ä»˜é‡‘é¢:</span>
                        <span id="downPaymentAmountDisplay" class="font-semibold text-gray-800">0.00 RMB</span>
                    </div>
                </div>

                <!-- è´·æ¬¾æœŸé™ -->
                <div class="relative">
                    <label for="term" class="block text-sm font-medium text-gray-700 mb-1">è´·æ¬¾æœŸé™ (å¹´)</label>
                    <input type="number" id="term" value="3" min="1" max="10" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150" oninput="calculateLoan()">
                    <span class="absolute right-3 top-9 text-gray-400 text-sm">å¹´</span>
                </div>

                <!-- è´·æ¬¾åˆ©ç‡ -->
                <div class="relative">
                    <label for="rate" class="block text-sm font-medium text-gray-700 mb-1">å¹´åˆ©ç‡ (%)</label>
                    <input type="number" id="rate" value="4.5" min="0.1" step="0.1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150" oninput="calculateLoan()">
                    <span class="absolute right-3 top-9 text-gray-400 text-sm">%</span>
                </div>
                
                <!-- è¿˜æ¬¾æ–¹å¼é€‰æ‹© -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©è¿˜æ¬¾æ–¹å¼</label>
                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                        <!-- ç­‰é¢æœ¬æ¯ (EMI) -->
                        <label for="type_emi" class="flex items-center space-x-2 p-3 rounded-lg border border-gray-300 has-[:checked]:border-primary has-[:checked]:ring-2 has-[:checked]:ring-primary transition duration-150 cursor-pointer w-full sm:w-1/2">
                            <input type="radio" id="type_emi" name="repaymentType" value="emi" checked onchange="calculateLoan()" class="text-primary focus:ring-primary h-4 w-4">
                            <span class="text-gray-800 font-medium">ç­‰é¢æœ¬æ¯ (EMI)</span>
                        </label>
                        <!-- ç­‰é¢æœ¬é‡‘ (EPR) -->
                        <label for="type_epr" class="flex items-center space-x-2 p-3 rounded-lg border border-gray-300 has-[:checked]:border-primary has-[:checked]:ring-2 has-[:checked]:ring-primary transition duration-150 cursor-pointer w-full sm:w-1/2">
                            <input type="radio" id="type_epr" name="repaymentType" value="epr" onchange="calculateLoan()" class="text-primary focus:ring-primary h-4 w-4">
                            <span class="text-gray-800 font-medium">ç­‰é¢æœ¬é‡‘ (EPR)</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 lg:h-full flex flex-col justify-between">
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2 border-gray-200">ğŸ’° è´·æ¬¾ç»“æœæ¦‚è§ˆ</h2>
                    
                    <!-- è´·æ¬¾æ€»é¢ -->
                    <div class="flex justify-between items-center py-2">
                        <span class="text-secondary">è´·æ¬¾æ€»é¢ (æœ¬é‡‘)</span>
                        <span id="loanAmountOutput" class="text-lg font-medium text-gray-800">0.00 RMB</span>
                    </div>

                    <!-- æ¯æœˆè¿˜æ¬¾é¢ -->
                    <div class="py-3 border-t border-b border-gray-200 my-2 bg-primary/5 rounded-lg px-3">
                        <span id="monthlyPaymentLabel" class="text-base font-bold text-primary block mb-1">æ¯æœˆè¿˜æ¬¾é¢</span>
                        <div class="flex justify-between items-baseline">
                            <span id="monthlyPaymentOutput" class="text-3xl font-extrabold text-primary">0.00 RMB</span>
                            <span id="monthlyPaymentSubLabel" class="text-sm text-gray-600 hidden"></span>
                        </div>
                    </div>

                    <!-- æ€»åˆ©æ¯ -->
                    <div class="flex justify-between items-center py-2">
                        <span class="text-secondary">æ€»åˆ©æ¯æ”¯å‡º</span>
                        <span id="totalInterestOutput" class="text-lg font-medium text-red-600">0.00 RMB</span>
                    </div>
                </div>

                <!-- ç»Ÿè®¡æ±‡æ€» -->
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">æ€»è®¡æ”¯ä»˜</h3>
                    <div class="flex justify-between items-center">
                        <span class="text-secondary">æ€»è®¡æ”¯ä»˜ (é¦–ä»˜ + æœ¬é‡‘ + åˆ©æ¯)</span>
                        <span id="totalPaidOutput" class="text-xl font-bold text-green-600">0.00 RMB</span>
                    </div>
                </div>
            </div>

        </div>
        
        <!-- é”™è¯¯ä¿¡æ¯ -->
        <div id="error-message" class="mt-6 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
            <span class="font-semibold">è¾“å…¥é”™è¯¯ï¼š</span>
            <span id="error-text">è¯·ç¡®ä¿è½¦è¾†æ€»ä»·å¤§äºå®é™…é¦–ä»˜é‡‘é¢ã€‚</span>
        </div>

    </div>

    <script>
        // æ ¼å¼åŒ–æ•°å­—ä¸ºäººæ°‘å¸è´§å¸æ ¼å¼
        // Note: The formatter uses the locale symbol (e.g., 'Â¥'). We manually append ' RMB' for clarity in the UI.
        const formatter = new Intl.NumberFormat('zh-CN', {
            style: 'currency',
            currency: 'CNY',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        });

        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–è´§å¸å¹¶æ·»åŠ  ' RMB'
        function formatRMB(value) {
            return formatter.format(value).replace('CNY', '').trim() + ' RMB';
        }

        // ä¸»è¦è®¡ç®—å‡½æ•°
        function calculateLoan() {
            // 1. è·å–è¾“å…¥å€¼
            const price = parseFloat(document.getElementById('price').value);
            const downPaymentPercent = parseFloat(document.getElementById('downPaymentPercent').value);
            const annualRate = parseFloat(document.getElementById('rate').value);
            const termYears = parseFloat(document.getElementById('term').value);
            const repaymentType = document.querySelector('input[name="repaymentType"]:checked').value; // 'emi' or 'epr'
            
            // 2. è·å–è¾“å‡ºå…ƒç´ 
            const loanAmountOutput = document.getElementById('loanAmountOutput');
            const downPaymentAmountDisplay = document.getElementById('downPaymentAmountDisplay');
            const monthlyPaymentLabel = document.getElementById('monthlyPaymentLabel');
            const monthlyPaymentOutput = document.getElementById('monthlyPaymentOutput');
            const monthlyPaymentSubLabel = document.getElementById('monthlyPaymentSubLabel');
            const totalInterestOutput = document.getElementById('totalInterestOutput');
            const totalPaidOutput = document.getElementById('totalPaidOutput');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');

            // 3. åŸºæœ¬è¾“å…¥æ ¡éªŒ (æ£€æŸ¥NaNå’Œéæ­£æ•°)
            if (isNaN(price) || isNaN(downPaymentPercent) || isNaN(annualRate) || isNaN(termYears) || price <= 0 || annualRate <= 0 || termYears <= 0) {
                errorMessage.classList.remove('hidden');
                errorText.textContent = "æ‰€æœ‰è¾“å…¥é¡¹éƒ½å¿…é¡»æ˜¯å¤§äºé›¶çš„æœ‰æ•ˆæ•°å­—ã€‚";
                // æ¸…ç©ºè¾“å‡º
                downPaymentAmountDisplay.textContent = '0.00 RMB';
                loanAmountOutput.textContent = '0.00 RMB';
                monthlyPaymentOutput.textContent = '0.00 RMB';
                totalInterestOutput.textContent = '0.00 RMB';
                totalPaidOutput.textContent = '0.00 RMB';
                monthlyPaymentSubLabel.classList.add('hidden');
                return;
            }

            // 4. è®¡ç®—é¦–ä»˜é‡‘é¢å’Œè´·æ¬¾æœ¬é‡‘
            const downPayment = price * (downPaymentPercent / 100);
            downPaymentAmountDisplay.textContent = formatRMB(downPayment);
            
            const principal = price - downPayment;

            // 5. æ ¸å¿ƒæ ¡éªŒï¼šè´·æ¬¾æœ¬é‡‘å¿…é¡»å¤§äºé›¶
            if (principal <= 0) {
                errorMessage.classList.remove('hidden');
                errorText.textContent = "è´·æ¬¾æ€»é¢å¿…é¡»å¤§äº 0ã€‚è¯·ç¡®ä¿è½¦è¾†æ€»ä»·å¤§äºå®é™…é¦–ä»˜é‡‘é¢ã€‚";
                // æ¸…ç©ºè´·æ¬¾ç›¸å…³è¾“å‡º
                loanAmountOutput.textContent = formatRMB(principal); 
                monthlyPaymentOutput.textContent = '0.00 RMB';
                totalInterestOutput.textContent = '0.00 RMB';
                totalPaidOutput.textContent = formatRMB(price);
                monthlyPaymentSubLabel.classList.add('hidden');
                return;
            }

            // æ¸…é™¤é”™è¯¯ä¿¡æ¯
            errorMessage.classList.add('hidden');

            // 6. è´·æ¬¾å‚æ•°è®¡ç®—
            const termMonths = termYears * 12; // æ€»æœˆæ•° (n)
            const monthlyRate = annualRate / 100 / 12; // æœˆåˆ©ç‡ (i)

            let monthlyPaymentM1 = 0; // é¦–æœˆè¿˜æ¬¾é¢
            let monthlyPaymentMn = 0; // æœ«æœˆè¿˜æ¬¾é¢
            let totalInterest = 0;
            let totalPaidPrincipalInterest = 0;

            if (repaymentType === 'emi') {
                // ç­‰é¢æœ¬æ¯ (Equal Monthly Installments - EMI)
                monthlyPaymentLabel.textContent = 'æ¯æœˆè¿˜æ¬¾é¢ (ç­‰é¢æœ¬æ¯)';
                monthlyPaymentSubLabel.classList.add('hidden');

                if (monthlyRate === 0) {
                    // æ— æ¯è´·æ¬¾
                    monthlyPaymentM1 = principal / termMonths;
                    totalInterest = 0;
                    totalPaidPrincipalInterest = principal;
                } else {
                    // M = P [ i(1 + i)^n ] / [ (1 + i)^n â€“ 1 ]
                    const power = Math.pow(1 + monthlyRate, termMonths);
                    monthlyPaymentM1 = principal * (monthlyRate * power) / (power - 1);
                    
                    totalPaidPrincipalInterest = monthlyPaymentM1 * termMonths;
                    totalInterest = totalPaidPrincipalInterest - principal;
                }
                monthlyPaymentMn = monthlyPaymentM1; // æœˆä¾›å›ºå®š

            } else if (repaymentType === 'epr') {
                // ç­‰é¢æœ¬é‡‘ (Equal Principal Repayments - EPR)
                monthlyPaymentLabel.textContent = 'é¦–æœˆè¿˜æ¬¾é¢ / æœ«æœˆè¿˜æ¬¾é¢ (ç­‰é¢æœ¬é‡‘)';
                monthlyPaymentSubLabel.classList.remove('hidden');

                const fixedPrincipal = principal / termMonths; // æ¯æœˆå›ºå®šè¿˜æ¬¾æœ¬é‡‘
                
                // 1. é¦–æœˆè¿˜æ¬¾é¢ M1 = å›ºå®šæœ¬é‡‘ + é¦–æœˆåˆ©æ¯ (åŸºäºå…¨éƒ¨æœ¬é‡‘ P)
                const interestM1 = principal * monthlyRate;
                monthlyPaymentM1 = fixedPrincipal + interestM1;

                // 2. æœ«æœˆè¿˜æ¬¾é¢ Mn = å›ºå®šæœ¬é‡‘ + æœ«æœˆåˆ©æ¯ (åŸºäºå‰©ä½™æœ¬é‡‘ P/n)
                // æœ€åä¸€ä¸ªæœˆ (k=n) çš„åˆ©æ¯æ˜¯åŸºäºä¸Šä¸ªæœˆæœ«çš„å‰©ä½™æœ¬é‡‘ P_n-1 = P - (n-1) * P_fixed = P_fixed
                const interestMn = fixedPrincipal * monthlyRate;
                monthlyPaymentMn = fixedPrincipal + interestMn;

                // 3. æ€»åˆ©æ¯ = P * i * (n + 1) / 2
                totalInterest = principal * monthlyRate * (termMonths + 1) / 2;
                
                // 4. æ€»è¿˜æ¬¾é¢ (æœ¬é‡‘ + åˆ©æ¯)
                totalPaidPrincipalInterest = principal + totalInterest;

                // æ˜¾ç¤ºé€’å‡ä¿¡æ¯
                const decreasePerMonth = monthlyRate * fixedPrincipal; // æ¯æœˆåˆ©æ¯é€’å‡é‡
                monthlyPaymentSubLabel.textContent = `æ¯æœˆé€’å‡çº¦ ${formatRMB(decreasePerMonth)}`;
                monthlyPaymentSubLabel.classList.remove('hidden');
            }

            // 7. æ›´æ–° DOM è¾“å‡º
            
            // è´·æ¬¾æ€»é¢ (Principal)
            loanAmountOutput.textContent = formatRMB(principal);
            
            // æ¯æœˆè¿˜æ¬¾é¢ (ä¸»æ˜¾ç¤ºå±)
            if (repaymentType === 'emi') {
                // EMI: æ˜¾ç¤ºå•ä¸€æœˆä¾›
                monthlyPaymentOutput.textContent = formatRMB(monthlyPaymentM1);
            } else {
                // EPR: æ˜¾ç¤ºèŒƒå›´ (é¦–æœˆ ~ æœ«æœˆ)
                monthlyPaymentOutput.textContent = `${formatRMB(monthlyPaymentM1)} ~ ${formatRMB(monthlyPaymentMn)}`;
            }
            
            // æ€»åˆ©æ¯æ”¯å‡º
            totalInterestOutput.textContent = formatRMB(totalInterest);
            
            // æ€»è®¡æ”¯ä»˜ = è´·æ¬¾æ€»è¿˜æ¬¾é¢ + é¦–ä»˜
            const totalPaid = totalPaidPrincipalInterest + downPayment;
            totalPaidOutput.textContent = formatRMB(totalPaid);
        }

        // é¡µé¢åŠ è½½å®Œæˆåç«‹å³è¿›è¡Œä¸€æ¬¡è®¡ç®—
        window.onload = calculateLoan;
    </script>
</body>
</html>