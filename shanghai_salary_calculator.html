<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>上海年薪计算器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .input-style {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            width: 100%;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .input-style:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
            outline: none;
        }
        .result-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .table-header {
            background-color: #eff6ff; /* blue-50 */
            color: #1e40af; /* blue-800 */
            font-weight: 600;
        }
        .rotated-header {
            writing-mode: vertical-rl;
            padding: 0 4px;
            white-space: nowrap;
        }
        /* 雇主缴纳项视觉区分 */
        .employer-col {
            background-color: #f5f3ff; /* purple-50 */
            color: #4c1d95; /* violet-700 */
            font-weight: 500;
        }
        /* 公司相关列：默认隐藏，点击按钮后显示 */
        .monthly-detail-table th.col-company,
        .monthly-detail-table td.col-company { display: none; }
        .monthly-detail-table.show-company-cols th.col-company,
        .monthly-detail-table.show-company-cols td.col-company { display: table-cell; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 rounded-xl result-card">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800 border-b pb-3">
            <svg class="inline w-6 h-6 mr-2 text-blue-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zM5 9a1 1 0 000 2h10a1 1 0 100-2H5z"></path></svg>
            上海年薪收入计算器 (累计预扣法)
        </h1>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- 月薪输入 -->
            <div>
                <label for="monthlySalary" class="block text-sm font-medium text-gray-700 mb-1">每月税前工资 (不含年终奖) RMB</label>
                <input type="number" id="monthlySalary" value="20000" class="input-style" placeholder="请输入月薪">
            </div>
            
            <!-- 公积金比例输入 -->
            <div>
                <label for="hfRateEmployee" class="block text-sm font-medium text-gray-700 mb-1">住房公积金个人/单位缴纳比例 (%)</label>
                <input type="number" id="hfRateEmployee" value="7" min="5" max="12" step="0.5" class="input-style" placeholder="5% ~ 12%">
            </div>

            <!-- 专项附加扣除输入 -->
            <div>
                <label for="specialDeduction" class="block text-sm font-medium text-gray-700 mb-1">每月专项附加扣除 (如子女教育等) RMB</label>
                <input type="number" id="specialDeduction" value="0" class="input-style" placeholder="请输入每月扣除额">
            </div>
             <!-- 年终奖输入 -->
            <div>
                <label for="annualBonus" class="block text-sm font-medium text-gray-700 mb-1">年终奖总额 RMB</label>
                <input type="number" id="annualBonus" value="30000" class="input-style" placeholder="请输入年终奖">
            </div>
        </div>
        
        <div class="text-center mb-6">
            <button onclick="calculateSalary()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-8 rounded-lg shadow-md transition duration-200">
                开始计算
            </button>
        </div>

        <!-- 结果展示区域 -->
        <div id="results" class="hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">核心年度数据摘要</h2>
            
            <!-- 总览卡片 (4 列，共 8 张卡片) -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-6">
                 <!-- NEW: 年度总用人成本 -->
                <div class="bg-pink-50 border-l-4 border-pink-500 p-4 rounded-lg result-card">
                    <p class="text-sm font-medium text-pink-600">年度总用人成本 (公司支出)</p>
                    <p id="totalAnnualEmployerCostDisplay" class="text-2xl font-bold text-pink-700 mt-1">0.00</p>
                </div>
                <!-- 1: 年度税前总收入 -->
                <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg result-card">
                    <p class="text-sm font-medium text-red-600">年度税前总收入 (含奖金)</p>
                    <p id="totalAnnualGrossDisplay" class="text-2xl font-bold text-red-700 mt-1">0.00</p>
                </div>
                
                <!-- 2: 年度总到手收入 (含奖金) -->
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg result-card">
                    <p class="text-sm font-medium text-blue-600">年度总到手收入 (含奖金)</p>
                    <p id="totalAnnualNetDisplay" class="text-2xl font-bold text-blue-700 mt-1">0.00</p>
                </div>

                <!-- 4: 年度净收入 + 公积金总和 -->
                <div class="bg-teal-50 border-l-4 border-teal-500 p-4 rounded-lg result-card">
                    <p class="text-sm font-medium text-teal-600">年度总净收入 + 公积金双边总计</p>
                    <p id="totalAnnualCashPlusFundDisplay" class="text-2xl font-bold text-teal-700 mt-1">0.00</p>
                </div>

                <!-- 3: 公积金双边存入总额 -->
                <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded-lg result-card">
                    <p class="text-sm font-medium text-indigo-600">年度公积金双边存入总额</p>
                    <p id="totalAnnualHousingFundDisplay" class="text-2xl font-bold text-indigo-700 mt-1">0.00</p>
                </div>

                <!-- 7: 年度公积金单边扣除 (个人) -->
                <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded-lg result-card">
                    <p class="text-sm font-medium text-purple-600">年度公积金单边扣除 (个人)</p>
                    <p id="totalAnnualHousingFundEmployeeDisplay" class="text-2xl font-bold text-purple-700 mt-1">0.00</p>
                </div>

                <!-- 5: 平均月到手 -->
                <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-lg result-card">
                    <p class="text-sm font-medium text-green-600">平均每月到手工资 (税后)</p>
                    <p id="netMonthlySalaryAvgDisplay" class="text-2xl font-bold text-green-700 mt-1">0.00</p>
                </div>
                
                <!-- 6: 年终奖到手 -->
                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-lg result-card">
                    <p class="text-sm font-medium text-yellow-600">年终奖到手 (税后)</p>
                    <p id="netBonusDisplay" class="text-2xl font-bold text-yellow-700 mt-1">0.00</p>
                </div>
            </div>

            <!-- 年度个人扣除明细表格 (抵税基数) -->
            <h3 class="text-xl font-semibold mb-3 mt-8 text-gray-800">年度个人扣除明细 (可抵税基数)</h3>
            <div class="overflow-x-auto rounded-lg border border-gray-200 result-card mb-8">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="table-header py-3 px-4 text-left text-xs uppercase tracking-wider rounded-tl-lg">扣除项目</th>
                            <th class="table-header py-3 px-4 text-right text-xs uppercase tracking-wider">年度总额 (RMB)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100 text-gray-700" id="annualIndividualDeductionBody">
                        <!-- Content populated by JS -->
                    </tbody>
                    <tfoot>
                         <tr>
                            <td class="px-4 py-2 text-base font-bold text-gray-800">年度综合扣除总计 (可抵税基数)</td>
                            <td id="totalAnnualTaxDeduction" class="px-4 py-2 text-right text-base font-bold text-red-700">0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- NEW: 年度雇主用人成本明细表格 -->
            <h3 class="text-xl font-semibold mb-3 mt-8 text-gray-800">年度雇主缴纳明细 (公司成本)</h3>
            <div class="overflow-x-auto rounded-lg border border-gray-200 result-card mb-8">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="table-header py-3 px-4 text-left text-xs uppercase tracking-wider rounded-tl-lg">缴纳项目 (公司部分)</th>
                            <th class="table-header py-3 px-4 text-right text-xs uppercase tracking-wider">年度总额 (RMB)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100 text-gray-700" id="annualEmployerCostBody">
                         <!-- Content populated by JS -->
                    </tbody>
                     <tfoot>
                         <tr>
                            <td class="px-4 py-2 text-base font-bold text-gray-800">年度公司五险一金缴纳总计</td>
                            <td id="totalAnnualEmployerContribution" class="px-4 py-2 text-right text-base font-bold text-pink-700">0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>


            <!-- 详细每月扣除表格 (Expanded) -->
            <h3 class="text-xl font-semibold mb-3 mt-8 text-gray-800">月度工资到手明细与公司成本 (个人/公司详细)</h3>
            <p class="mb-2">
                <button type="button" id="toggleCompanyColsBtn" onclick="toggleCompanyCols()" class="text-sm px-3 py-1.5 rounded border border-gray-300 bg-gray-100 hover:bg-gray-200 text-gray-700 transition">
                    显示公司相关列
                </button>
            </p>
            <div class="overflow-x-auto rounded-lg border border-gray-200 result-card">
                <table id="monthlyDetailTable" class="monthly-detail-table min-w-full divide-y divide-gray-200 text-xs">
                    <thead>
                        <tr class="table-header">
                            <th class="py-3 px-2 text-left uppercase tracking-wider">月份</th>
                            <th class="py-3 px-2 text-right uppercase tracking-wider">税前工资</th>
                            <!-- 个人缴纳部分 -->
                            <th class="py-3 px-2 text-right uppercase tracking-wider rotated-header">养老(个)</th>
                            <th class="py-3 px-2 text-right uppercase tracking-wider rotated-header">医疗(个)</th>
                            <th class="py-3 px-2 text-right uppercase tracking-wider rotated-header">失业(个)</th>
                            <th class="py-3 px-2 text-right uppercase tracking-wider rotated-header text-purple-800">公积金(个)</th>
                            <th class="py-3 px-2 text-right uppercase tracking-wider rotated-header">专项附加</th>
                            <th class="py-3 px-2 text-right uppercase tracking-wider">个税扣除</th>
                            <!-- 公司缴纳部分 -->
                            <th class="col-company py-3 px-2 text-right uppercase tracking-wider rotated-header employer-col">养老(司)</th>
                            <th class="col-company py-3 px-2 text-right uppercase tracking-wider rotated-header employer-col">医疗(司)</th>
                            <th class="col-company py-3 px-2 text-right uppercase tracking-wider rotated-header employer-col">失业(司)</th>
                            <th class="col-company py-3 px-2 text-right uppercase tracking-wider rotated-header employer-col">工伤(司)</th>
                            <th class="col-company py-3 px-2 text-right uppercase tracking-wider rotated-header text-purple-800 employer-col">公积金(司)</th>
                            <!-- 汇总数据 -->
                            <th class="col-company py-3 px-2 text-right uppercase tracking-wider">公司月总成本</th>
                            <th class="py-3 px-2 text-right uppercase tracking-wider">税后到手工资</th>
                            <th class="py-3 px-2 text-right uppercase tracking-wider">税后+公积金(双边)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100 text-gray-700" id="monthlyResultsTableBody">
                        <!-- Content populated by JS -->
                    </tbody>
                    <tfoot>
                         <tr>
                            <td class="px-2 py-3 text-sm font-semibold text-gray-800">年度总计</td>
                            <td id="totalAnnualGrossSalary" class="px-2 py-3 text-right text-sm font-semibold text-gray-800">0.00</td>
                            <td id="totalPensionE" class="px-2 py-3 text-right text-sm font-semibold text-red-600">0.00</td>
                            <td id="totalMedicalE" class="px-2 py-3 text-right text-sm font-semibold text-red-600">0.00</td>
                            <td id="totalUnemploymentE" class="px-2 py-3 text-right text-sm font-semibold text-red-600">0.00</td>
                            <td id="totalHousingFundE" class="px-2 py-3 text-right text-sm font-semibold text-purple-700">0.00</td>
                            <td id="totalSpecialDeduction" class="px-2 py-3 text-right text-sm font-semibold text-red-600">0.00</td>
                            <td id="totalIIT" class="px-2 py-3 text-right text-sm font-semibold text-red-600">0.00</td>
                            <!-- 公司缴纳总计 -->
                            <td id="totalPensionC" class="col-company px-2 py-3 text-right text-sm font-semibold employer-col">0.00</td>
                            <td id="totalMedicalC" class="col-company px-2 py-3 text-right text-sm font-semibold employer-col">0.00</td>
                            <td id="totalUnemploymentC" class="col-company px-2 py-3 text-right text-sm font-semibold employer-col">0.00</td>
                            <td id="totalWorkInjuryC" class="col-company px-2 py-3 text-right text-sm font-semibold employer-col">0.00</td>
                            <td id="totalHousingFundC" class="col-company px-2 py-3 text-right text-sm font-semibold text-purple-700 employer-col">0.00</td>
                            <!-- 汇总数据 -->
                            <td id="totalEmployerCostAnnual" class="col-company px-2 py-3 text-right text-sm font-bold text-pink-700">0.00</td>
                            <td id="totalNetSalary" class="px-2 py-3 text-right text-sm font-semibold text-green-700">0.00</td>
                            <td id="totalNetPlusHF" class="px-2 py-3 text-right text-sm font-semibold text-teal-700">0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

             <!-- 年终奖详情 -->
            <h3 class="text-xl font-semibold mb-3 mt-8 text-gray-800">年终奖税费计算 (单独计税)</h3>
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <p class="mb-1">
                    <span class="font-medium text-gray-600">税前年终奖:</span> 
                    <span id="grossBonusDisplay" class="font-semibold text-gray-800">0.00</span> RMB
                </p>
                <p class="mb-1">
                    <span class="font-medium text-gray-600">年终奖适用税率:</span> 
                    <span id="bonusTaxRateDisplay" class="font-semibold text-red-600">0%</span>
                </p>
                <p class="mb-1">
                    <span class="font-medium text-gray-600">年终奖应纳税额:</span> 
                    <span id="bonusTaxDisplay" class="font-bold text-red-600">0.00</span> RMB
                </p>
                <p class="mt-2 font-bold text-lg">
                    <span class="text-gray-600">年终奖税后到手:</span> 
                    <span id="netBonusResultDisplay" class="text-green-700">0.00</span> RMB
                </p>
            </div>


            <!-- 备注说明 -->
            <div class="mt-8 p-4 bg-yellow-50 text-yellow-800 rounded-lg text-sm border border-yellow-200">
                <p class="font-semibold mb-1">计算说明 (上海预估基数 2024/2025):</p>
                <ul class="list-disc list-inside space-y-0.5">
                    <li>**费率说明：** 社保费率采用了上海市常见的费率（个人养老 8%，医保 2%，失业 0.5%；单位养老 16%，医保 8%，失业 0.5%，工伤 0.26%）。实际费率可能因行业和地区而异。</li>
                    <li>**年度总净收入 + 公积金双边总计：** 衡量个人所有现金流入和长期储蓄（公积金）的总金额。</li>
                    <li>**社保公积金基数：** 采用上海市 2025 年 7 月起标准（社保 7,460 - 37,302；公积金 2,690 - 37,302）。</li>
                    <li>**个税计算：** 严格采用**累计预扣法**，因此个税扣除金额会随着月份的累积而变化，尤其是在年初。</li>
                    <li>**年终奖税：** 采用**单独计税**的优惠方式计算。</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // 定义五险一金费率和基数上下限 (2025年7月起上海标准)
        const RATES = {
            // Individual (Employee - E) 个人
            PENSION_E: 0.08,      // 养老 (个人)
            MEDICAL_E: 0.02,      // 医疗 (个人), 移除了 3 RMB 固定费
            UNEMPLOYMENT_E: 0.005,  // 失业 (个人)
            
            // Employer (Company - C) 单位
            PENSION_C: 0.16,      // 养老 (单位)
            MEDICAL_C: 0.08,      // 医疗 (单位)
            UNEMPLOYMENT_C: 0.005,  // 失业 (单位)
            WORK_INJURY_C: 0.0026, // 工伤 (单位, 示例费率)
        };

        const LIMITS = {
            SS_LOWER: 7460,  // 社保下限 (养老/医疗/失业/工伤) 2025.7起
            SS_UPPER: 37302, // 社保上限 2025.7起
            HF_LOWER: 2690,  // 公积金下限 2025.7起
            HF_UPPER: 37302, // 公积金上限 2025.7起
        };

        const TAX_DEDUCTION_ANNUAL_BASIC = 60000; // 每年基本减除费用 (60000 / 12 = 5000元/月)

        // 年度税率表 (用于累计预扣法和年终奖计算)
        const TAX_BRACKETS = [
            { threshold: 0, rate: 0.03, quick: 0 },
            { threshold: 36000, rate: 0.10, quick: 2520 },
            { threshold: 144000, rate: 0.20, quick: 16920 },
            { threshold: 300000, rate: 0.25, quick: 31920 },
            { threshold: 420000, rate: 0.30, quick: 52920 },
            { threshold: 660000, rate: 0.35, quick: 85920 },
            { threshold: 960000, rate: 0.45, quick: 181920 },
        ];

        // 辅助函数：格式化数字为千位分隔符
        const formatRMB = (num) => parseFloat(num).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

        /**
         * 计算五险一金月扣除额 (包含个人、单位 breakdown 及双边总额)
         * @param {number} monthlySalary - 月度税前工资
         * @param {number} hfRateEmployee - 住房公积金个人/单位缴纳比例 (0.05 - 0.12)
         * @returns {object} 包含各项扣除额和总额
         */
        function calculateDeductions(monthlySalary, hfRateEmployee) {
            // 确定社保基数 (养老, 医疗, 失业, 工伤)
            let ssBase = Math.min(Math.max(monthlySalary, LIMITS.SS_LOWER), LIMITS.SS_UPPER);
            // 确定公积金基数
            let hfBase = Math.min(Math.max(monthlySalary, LIMITS.HF_LOWER), LIMITS.HF_UPPER);

            // 1. 个人缴纳 (Employee - E)
            const pension_e = ssBase * RATES.PENSION_E;
            const medical_e = ssBase * RATES.MEDICAL_E; 
            const unemployment_e = ssBase * RATES.UNEMPLOYMENT_E;
            const housingFund_e = hfBase * hfRateEmployee;
            const individualTotal = pension_e + medical_e + unemployment_e + housingFund_e;

            // 2. 单位缴纳 (Company - C)
            const pension_c = ssBase * RATES.PENSION_C;
            const medical_c = ssBase * RATES.MEDICAL_C;
            const unemployment_c = ssBase * RATES.UNEMPLOYMENT_C;
            const workInjury_c = ssBase * RATES.WORK_INJURY_C;
            const housingFund_c = hfBase * hfRateEmployee; // 公积金单位和个人比例一致
            const employerTotal = pension_c + medical_c + unemployment_c + workInjury_c + housingFund_c;

            return {
                // Individual Breakdown
                pension_e, medical_e, unemployment_e, housingFund_e,
                individualTotal, // 个人五险一金总扣除 (可抵税)
                
                // Employer Breakdown
                pension_c, medical_c, unemployment_c, workInjury_c, housingFund_c,
                employerTotal, // 公司五险一金总缴纳

                // Totals
                housingFundTotalContribution: housingFund_e + housingFund_c, // 双边公积金总额
            };
        }

        /**
         * 计算年终奖税费（单独计税）
         * @param {number} bonus - 年终奖金额
         * @returns {object} 包含税额和税后金额
         */
        function calculateBonusTax(bonus) {
            if (bonus <= 0) {
                return { tax: 0, net: 0, rate: '0%', quick: 0 };
            }
            
            // 1. 将年终奖除以 12 确定税率
            const monthlyEquivalent = bonus / 12;

            let rate = 0;
            let quick = 0;

            // 2. 查找适用的税率和速算扣除数 (使用月等效金额查找年度税率表)
            for (let i = TAX_BRACKETS.length - 1; i >= 0; i--) {
                const bracket = TAX_BRACKETS[i];
                if (monthlyEquivalent * 12 > bracket.threshold) {
                    rate = bracket.rate;
                    quick = bracket.quick;
                    break;
                }
            }
            
            // 3. 计算税额: 应纳税所得额 = 全额年终奖
            const tax = bonus * rate - quick;
            const netBonus = bonus - tax;

            return {
                tax: Math.max(0, tax),
                net: Math.max(0, netBonus),
                rate: `${(rate * 100).toFixed(0)}%`,
                quick: quick
            };
        }


        function calculateSalary() {
            try {
                // 1. 获取输入
                const monthlySalary = parseFloat(document.getElementById('monthlySalary').value) || 0;
                const annualBonus = parseFloat(document.getElementById('annualBonus').value) || 0;
                const specialDeductionMonthly = parseFloat(document.getElementById('specialDeduction').value) || 0;
                
                // 公积金比例转换为小数，并校验范围
                let hfRateEmployee = parseFloat(document.getElementById('hfRateEmployee').value);
                if (isNaN(hfRateEmployee) || hfRateEmployee < 5 || hfRateEmployee > 12) {
                     hfRateEmployee = 7;
                     document.getElementById('hfRateEmployee').value = 7; 
                }
                hfRateEmployee = hfRateEmployee / 100;


                const monthlyResults = [];
                let cumulativeTaxPaid = 0; // 累计已缴纳个税
                
                let totalAnnualNetSalary = 0; // 12个月净工资
                let totalAnnualIIT = 0;
                let totalAnnualHousingFund = 0; // 双边存入总额
                
                // 预先计算固定的月度五险一金扣除额和单位缴纳额
                const deductions = calculateDeductions(monthlySalary, hfRateEmployee);
                const totalMonthlyDeductionWuxianYijin = deductions.individualTotal; // 个人五险一金总扣除

                // 2. 循环计算12个月 (累计预扣法核心逻辑)
                for (let month = 1; month <= 12; month++) {
                    
                    // A. 月度数据 (假设月薪稳定)
                    const monthlyGross = monthlySalary;
                    
                    // B. 累计应纳税所得额
                    const cumulativeGross = monthlyGross * month;
                    const cumulativeWuxianYijin = totalMonthlyDeductionWuxianYijin * month; 
                    const cumulativeSpecialDeduction = specialDeductionMonthly * month;
                    const cumulativeBasicDeduction = month * (TAX_DEDUCTION_ANNUAL_BASIC / 12); 

                    // 累计预扣预缴应纳税所得额
                    const cumulativeTaxableIncome = cumulativeGross - cumulativeWuxianYijin - cumulativeSpecialDeduction - cumulativeBasicDeduction;

                    // C. 计算累计应缴税额
                    let cumulativeTaxPayable = 0;
                    let applicableRate = 0;
                    
                    for (let i = TAX_BRACKETS.length - 1; i >= 0; i--) {
                        const bracket = TAX_BRACKETS[i];
                        if (cumulativeTaxableIncome > bracket.threshold) {
                            cumulativeTaxPayable = cumulativeTaxableIncome * bracket.rate - bracket.quick;
                            applicableRate = bracket.rate;
                            break;
                        }
                    }
                    
                    // D. 计算本月应预扣个税
                    const monthlyIIT = Math.max(0, cumulativeTaxPayable - cumulativeTaxPaid);
                    
                    // E. 更新累计值和年度总计
                    cumulativeTaxPaid += monthlyIIT;
                    totalAnnualIIT += monthlyIIT;
                    totalAnnualHousingFund += deductions.housingFundTotalContribution; 

                    // F. 计算月度税后到手工资
                    const netMonthlySalary = monthlyGross - totalMonthlyDeductionWuxianYijin - monthlyIIT;
                    totalAnnualNetSalary += netMonthlySalary;

                    // G. 额外计算公司月总成本 (月薪 + 单位缴纳五险一金总额)
                    const monthlyEmployerCost = monthlyGross + deductions.employerTotal;

                    monthlyResults.push({
                        month,
                        // Individual Deductions Breakdown
                        pension_e: deductions.pension_e,
                        medical_e: deductions.medical_e,
                        unemployment_e: deductions.unemployment_e,
                        housingFund_e: deductions.housingFund_e,
                        // Employer Deductions Breakdown (New)
                        pension_c: deductions.pension_c,
                        medical_c: deductions.medical_c,
                        unemployment_c: deductions.unemployment_c,
                        workInjury_c: deductions.workInjury_c,
                        housingFund_c: deductions.housingFund_c,

                        specialDeduction: specialDeductionMonthly,
                        iit: monthlyIIT,
                        net: netMonthlySalary,
                        monthlyEmployerCost: monthlyEmployerCost, // NEW
                        cumulativeTaxableIncome: cumulativeTaxableIncome,
                        applicableRate: applicableRate * 100,
                        monthlyGross
                    });
                }
                
                // 3. 计算年终奖数据
                const bonusResult = calculateBonusTax(annualBonus);
                
                // 4. 计算年度总数据
                const totalAnnualNet = totalAnnualNetSalary + bonusResult.net;
                const netMonthlySalaryAvg = totalAnnualNetSalary / 12;
                
                // 年度税前总收入 (月薪 * 12 + 年终奖)
                const totalAnnualGross = monthlySalary * 12 + annualBonus;
                
                // 详细年度扣除分项计算 (使用 monthly deductions * 12)
                const totalAnnualPensionE = deductions.pension_e * 12;
                const totalAnnualMedicalE = deductions.medical_e * 12;
                const totalAnnualUnemploymentE = deductions.unemployment_e * 12;
                const totalAnnualHousingFundEmployee = deductions.housingFund_e * 12; // 个人单边公积金
                const totalAnnualSpecialDeduction = specialDeductionMonthly * 12;
                
                // 年度综合扣除总计 (可抵税基数部分，即 五险一金个人 + 专项附加)
                const totalAnnualTaxDeduction = totalAnnualPensionE + totalAnnualMedicalE + totalAnnualUnemploymentE + totalAnnualHousingFundEmployee + totalAnnualSpecialDeduction;

                // 年度公司缴纳分项
                const totalAnnualPensionC = deductions.pension_c * 12;
                const totalAnnualMedicalC = deductions.medical_c * 12;
                const totalAnnualUnemploymentC = deductions.unemployment_c * 12;
                const totalAnnualWorkInjuryC = deductions.workInjury_c * 12;
                const totalAnnualHousingFundC = deductions.housingFund_c * 12;
                const totalAnnualEmployerContribution = deductions.employerTotal * 12; // 公司五险一金总缴纳

                // 年度总净收入 + 公积金总和
                const totalAnnualCashPlusFund = totalAnnualNet + totalAnnualHousingFund;
                
                // NEW: 年度总用人成本 = 年度税前总收入 + 年度公司五险一金缴纳总计
                const totalAnnualEmployerCost = totalAnnualGross + totalAnnualEmployerContribution;


                // 5. 更新UI

                // A. 摘要卡片
                document.getElementById('totalAnnualEmployerCostDisplay').textContent = formatRMB(totalAnnualEmployerCost);
                document.getElementById('totalAnnualGrossDisplay').textContent = formatRMB(totalAnnualGross);
                document.getElementById('totalAnnualNetDisplay').textContent = formatRMB(totalAnnualNet);
                document.getElementById('totalAnnualCashPlusFundDisplay').textContent = formatRMB(totalAnnualCashPlusFund);
                document.getElementById('totalAnnualHousingFundDisplay').textContent = formatRMB(totalAnnualHousingFund);
                document.getElementById('totalAnnualHousingFundEmployeeDisplay').textContent = formatRMB(totalAnnualHousingFundEmployee);
                document.getElementById('netMonthlySalaryAvgDisplay').textContent = formatRMB(netMonthlySalaryAvg);
                document.getElementById('netBonusDisplay').textContent = formatRMB(bonusResult.net);


                // B. 年度个人扣除明细表格
                const annualIndividualBody = document.getElementById('annualIndividualDeductionBody');
                annualIndividualBody.innerHTML = `
                    <tr><td class="px-4 py-2 text-sm">养老保险 (个人)</td><td class="px-4 py-2 text-right text-sm text-red-600">${formatRMB(totalAnnualPensionE)}</td></tr>
                    <tr><td class="px-4 py-2 text-sm">医疗保险 (个人)</td><td class="px-4 py-2 text-right text-sm text-red-600">${formatRMB(totalAnnualMedicalE)}</td></tr>
                    <tr><td class="px-4 py-2 text-sm">失业保险 (个人)</td><td class="px-4 py-2 text-right text-sm text-red-600">${formatRMB(totalAnnualUnemploymentE)}</td></tr>
                    <tr><td class="px-4 py-2 text-sm font-medium">住房公积金 (个人单边)</td><td class="px-4 py-2 text-right text-sm font-medium text-purple-700">${formatRMB(totalAnnualHousingFundEmployee)}</td></tr>
                    <tr><td class="px-4 py-2 text-sm">专项附加扣除 (子女教育、房贷等)</td><td class="px-4 py-2 text-right text-sm text-red-600">${formatRMB(totalAnnualSpecialDeduction)}</td></tr>
                `;
                document.getElementById('totalAnnualTaxDeduction').textContent = formatRMB(totalAnnualTaxDeduction);


                // C. NEW: 年度雇主用人成本明细表格
                const annualEmployerBody = document.getElementById('annualEmployerCostBody');
                annualEmployerBody.innerHTML = `
                    <tr><td class="px-4 py-2 text-sm">养老保险 (单位)</td><td class="px-4 py-2 text-right text-sm text-pink-600">${formatRMB(totalAnnualPensionC)}</td></tr>
                    <tr><td class="px-4 py-2 text-sm">医疗保险 (单位)</td><td class="px-4 py-2 text-right text-sm text-pink-600">${formatRMB(totalAnnualMedicalC)}</td></tr>
                    <tr><td class="px-4 py-2 text-sm">失业保险 (单位)</td><td class="px-4 py-2 text-right text-sm text-pink-600">${formatRMB(totalAnnualUnemploymentC)}</td></tr>
                    <tr><td class="px-4 py-2 text-sm">工伤保险 (单位)</td><td class="px-4 py-2 text-right text-sm text-pink-600">${formatRMB(totalAnnualWorkInjuryC)}</td></tr>
                    <tr><td class="px-4 py-2 text-sm font-medium">住房公积金 (单位单边)</td><td class="px-4 py-2 text-right text-sm font-medium text-purple-700">${formatRMB(totalAnnualHousingFundC)}</td></tr>
                `;
                document.getElementById('totalAnnualEmployerContribution').textContent = formatRMB(totalAnnualEmployerContribution);


                // D. 月度明细表格
                const resultsBody = document.getElementById('monthlyResultsTableBody');
                resultsBody.innerHTML = ''; // 清空旧数据

                let totalPensionE_month = 0;
                let totalMedicalE_month = 0;
                let totalUnemploymentE_month = 0;
                let totalHousingFundE_month = 0;
                let totalSpecialDeduction_month = 0;
                // 新增雇主年度总计变量
                let totalPensionC_month = 0;
                let totalMedicalC_month = 0;
                let totalUnemploymentC_month = 0;
                let totalWorkInjuryC_month = 0;
                let totalHousingFundC_month = 0;
                let totalEmployerCost_Annual = 0; // 对应表格中的公司月总成本年度总和

                monthlyResults.forEach(item => {
                    totalPensionE_month += item.pension_e;
                    totalMedicalE_month += item.medical_e;
                    totalUnemploymentE_month += item.unemployment_e;
                    totalHousingFundE_month += item.housingFund_e;
                    totalSpecialDeduction_month += item.specialDeduction;
                    
                    // 雇主年度总计累加
                    totalPensionC_month += item.pension_c;
                    totalMedicalC_month += item.medical_c;
                    totalUnemploymentC_month += item.unemployment_c;
                    totalWorkInjuryC_month += item.workInjury_c;
                    totalHousingFundC_month += item.housingFund_c;
                    totalEmployerCost_Annual += item.monthlyEmployerCost;

                    const row = resultsBody.insertRow();
                    row.className = item.month % 2 === 0 ? 'bg-gray-50' : '';
                    row.innerHTML = `
                        <td class="px-2 py-2 text-left text-sm font-medium text-gray-800">${item.month}月</td>
                        <td class="px-2 py-2 text-right text-sm font-medium text-gray-800">${formatRMB(item.monthlyGross)}</td>
                        <td class="px-2 py-2 text-right text-sm text-red-600">${formatRMB(item.pension_e)}</td>
                        <td class="px-2 py-2 text-right text-sm text-red-600">${formatRMB(item.medical_e)}</td>
                        <td class="px-2 py-2 text-right text-sm text-red-600">${formatRMB(item.unemployment_e)}</td>
                        <td class="px-2 py-2 text-right text-sm font-medium text-purple-700">${formatRMB(item.housingFund_e)}</td>
                        <td class="px-2 py-2 text-right text-sm text-red-600">${formatRMB(item.specialDeduction)}</td>
                        <td class="px-2 py-2 text-right text-sm font-semibold text-red-700">${formatRMB(item.iit)}</td>
                        
                        <!-- 雇主缴纳明细 -->
                        <td class="col-company px-2 py-2 text-right text-sm employer-col">${formatRMB(item.pension_c)}</td>
                        <td class="col-company px-2 py-2 text-right text-sm employer-col">${formatRMB(item.medical_c)}</td>
                        <td class="col-company px-2 py-2 text-right text-sm employer-col">${formatRMB(item.unemployment_c)}</td>
                        <td class="col-company px-2 py-2 text-right text-sm employer-col">${formatRMB(item.workInjury_c)}</td>
                        <td class="col-company px-2 py-2 text-right text-sm font-medium text-purple-700 employer-col">${formatRMB(item.housingFund_c)}</td>

                        <td class="col-company px-2 py-2 text-right text-sm font-bold text-pink-700">${formatRMB(item.monthlyEmployerCost)}</td>
                        <td class="px-2 py-2 text-right text-sm font-bold text-green-700">${formatRMB(item.net)}</td>
                        <td class="px-2 py-2 text-right text-sm font-bold text-teal-700">${formatRMB(item.net + item.housingFund_e + item.housingFund_c)} <span class="text-gray-500 font-normal">(${formatRMB(item.housingFund_e + item.housingFund_c)})</span></td>
                    `;
                });
                
                // E. 月度表格底部的汇总
                document.getElementById('totalAnnualGrossSalary').textContent = formatRMB(monthlySalary * 12); 
                document.getElementById('totalPensionE').textContent = formatRMB(totalPensionE_month);
                document.getElementById('totalMedicalE').textContent = formatRMB(totalMedicalE_month);
                document.getElementById('totalUnemploymentE').textContent = formatRMB(totalUnemploymentE_month);
                document.getElementById('totalHousingFundE').textContent = formatRMB(totalHousingFundE_month);
                document.getElementById('totalSpecialDeduction').textContent = formatRMB(totalSpecialDeduction_month);
                document.getElementById('totalIIT').textContent = formatRMB(totalAnnualIIT);
                document.getElementById('totalNetSalary').textContent = formatRMB(totalAnnualNetSalary);
                document.getElementById('totalNetPlusHF').innerHTML = `${formatRMB(totalAnnualNetSalary + totalHousingFundE_month + totalHousingFundC_month)} <span class="text-gray-500 font-normal">(${formatRMB(totalHousingFundE_month + totalHousingFundC_month)})</span>`;

                // 雇主汇总更新
                document.getElementById('totalPensionC').textContent = formatRMB(totalPensionC_month);
                document.getElementById('totalMedicalC').textContent = formatRMB(totalMedicalC_month);
                document.getElementById('totalUnemploymentC').textContent = formatRMB(totalUnemploymentC_month);
                document.getElementById('totalWorkInjuryC').textContent = formatRMB(totalWorkInjuryC_month);
                document.getElementById('totalHousingFundC').textContent = formatRMB(totalHousingFundC_month);
                document.getElementById('totalEmployerCostAnnual').textContent = formatRMB(totalEmployerCost_Annual);


                // F. 年终奖详情
                document.getElementById('grossBonusDisplay').textContent = formatRMB(annualBonus);
                document.getElementById('bonusTaxRateDisplay').textContent = bonusResult.rate;
                document.getElementById('bonusTaxDisplay').textContent = formatRMB(bonusResult.tax);
                document.getElementById('netBonusResultDisplay').textContent = formatRMB(bonusResult.net);

                document.getElementById('results').classList.remove('hidden');

            } catch (error) {
                console.error("计算出错:", error);
                document.getElementById('results').innerHTML = '<p class="text-red-500 text-center">计算发生错误，请检查输入是否为有效数字。</p>';
                document.getElementById('results').classList.remove('hidden');
            }
        }

        function toggleCompanyCols() {
            const table = document.getElementById('monthlyDetailTable');
            const btn = document.getElementById('toggleCompanyColsBtn');
            if (!table || !btn) return;
            const show = table.classList.toggle('show-company-cols');
            btn.textContent = show ? '隐藏公司相关列' : '显示公司相关列';
        }

        // 初始化计算，加载默认值
        window.onload = function() {
            calculateSalary();
        };

    </script>
</body>
</html>
